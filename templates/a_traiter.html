<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>A traiter</title>
  <style>
    :root {
      --primary: #2d6cdf;
      --success: #16a34a;
      --danger: #dc2626;
      --warning: #f59e0b;
      --muted: #9ca3af;
      --text: #111827;
      --border: #e5e7eb;
      --bg: #f4f6fb;
      --card: #ffffff;
    }

    * { box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      color: var(--text);
    }

    .wrap {
      width: calc(100% - 32px);
      margin: 16px;
      background: var(--card);
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      overflow-x: auto;
    }

    .page-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand img {
      height: 52px;
      width: auto;
      border-radius: 8px;
      background: #fff;
    }

    h1 { margin: 0; }

    a {
      color: var(--primary);
      text-decoration: none;
    }

    a:hover { opacity: 0.85; }

    table {
      width: 100%;
      min-width: 1800px;
      border-collapse: collapse;
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 10px;
      text-align: left;
      vertical-align: top;
    }

    .btn {
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: var(--primary);
      color: white;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
    }

    .btn:hover { opacity: 0.92; }

    .btn.grey,
    .btn[disabled] {
      background: var(--muted);
      cursor: not-allowed;
      pointer-events: none;
    }

    .btn.success {
      background: var(--success);
    }

    .btn.danger {
      background: var(--danger);
    }

    form[action^="/delete/"] .btn.danger {
      margin-top: 6px;
    }

    .btn.warning-pending {
      background: var(--warning);
      animation: pulse 1.2s infinite;
    }

    .btn.demande-a-faire-row {
      margin-top: 8px;
      background: var(--danger);
      animation: pulse-danger 1.2s infinite;
    }

    .recap-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 18px;
    }

    .recap-card {
      border-radius: 14px;
      padding: 12px 14px;
      color: #fff;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .recap-title {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 6px;
    }

    .recap-value {
      font-size: 28px;
      font-weight: 700;
      line-height: 1;
    }

    .recap-nouveau { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .recap-demande { background: linear-gradient(135deg, #f97316, #ea580c); }
    .recap-documents { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .recap-compte { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .recap-instruction { background: linear-gradient(135deg, #14b8a6, #0f766e); }

    .demande-hidden {
      display: none !important;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, .6); }
      100% { box-shadow: 0 0 0 14px rgba(245, 158, 11, 0); }
    }

    @keyframes pulse-danger {
      0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, .6); }
      100% { box-shadow: 0 0 0 14px rgba(220, 38, 38, 0); }
    }

    .commentaire-input,
    .telephone-input,
    .cnaps-select {
      width: 100%;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font: inherit;
      background: #fff;
    }

    .save-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
    }

    .statut-transmis { background-color: gray; color: white; font-weight: bold; }
    .statut-enregistre { background-color: orange; color: white; font-weight: bold; }
    .statut-instruction { background-color: gold; color: black; font-weight: bold; }
    .statut-accepte { background-color: green; color: white; font-weight: bold; }
    .statut-refuse { background-color: black; color: white; font-weight: bold; }
    .statut-docsmanquants { background-color: red; color: white; font-weight: bold; }
    .statut-default { background-color: lightgray; color: black; font-weight: bold; }

    .espace-a-creer { background-color: #dc2626; color: white; font-weight: bold; }
    .espace-cree { background-color: #f59e0b; color: white; font-weight: bold; }
    .espace-valide { background-color: #16a34a; color: white; font-weight: bold; }

    .cnaps-select {
      border: none;
      font-weight: bold;
      min-height: 40px;
      cursor: pointer;
    }

    .cnaps-expiration {
      margin-top: 8px;
      font-size: 12px;
      color: #1f2937;
      line-height: 1.3;
    }

    .cnaps-reminder-action {
      margin-top: 6px;
      border: none;
      background: transparent;
      color: var(--primary);
      font-size: 12px;
      text-decoration: underline;
      cursor: pointer;
      padding: 0;
    }

    .cnaps-reminder-action[disabled] {
      color: #9ca3af;
      cursor: not-allowed;
      text-decoration: none;
    }

    .cnaps-reminder-sent {
      margin-top: 4px;
      font-size: 12px;
      color: #f59e0b;
      font-weight: 600;
      line-height: 1.3;
    }

    .cnaps-expired-badge {
      margin-top: 8px;
      display: inline-block;
      background: #dc2626;
      color: #fff;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 700;
    }
  </style>
</head>
<body>
<div class="wrap">
  {% set recap_ns = namespace(demande=0, nouveau=0, documents=0, compte=0, instruction=0) %}
  {% for item in requests %}
    {% set item_espace = (item.espace_cnaps or 'A créer')|trim %}
    {% set item_cnaps = (item.statut_cnaps or '')|trim %}
    {% set item_cnaps_empty = (item_cnaps == '' or item_cnaps == '--') %}
    {% if not (item.formation and item.session_date) %}
      {% set recap_ns.nouveau = recap_ns.nouveau + 1 %}
    {% endif %}
    {% if item_espace == 'Validé' and item_cnaps_empty %}
      {% set recap_ns.demande = recap_ns.demande + 1 %}
    {% endif %}
    {% set recap_ns.documents = recap_ns.documents + (item.en_attente or 0) %}
    {% if item_espace == 'A créer' %}
      {% set recap_ns.compte = recap_ns.compte + 1 %}
    {% endif %}
    {% if item_cnaps == 'INSTRUCTION' %}
      {% set recap_ns.instruction = recap_ns.instruction + 1 %}
    {% endif %}
  {% endfor %}

  <div class="page-head">
    <div class="brand">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo Intégrale Academy">
      <h1>Demande CNAPS en cours</h1>
    </div>
    <a href="/">← Retour</a>
  </div>

  <section class="recap-grid" aria-label="Tableau récapitulatif">
    <div class="recap-card recap-nouveau">
      <div class="recap-title">Nouveau dossier</div>
      <div class="recap-value" id="recapNouveau">{{ recap_ns.nouveau }}</div>
    </div>
    <div class="recap-card recap-demande">
      <div class="recap-title">Demande à faire</div>
      <div class="recap-value" id="recapDemande">{{ recap_ns.demande }}</div>
    </div>
    <div class="recap-card recap-documents">
      <div class="recap-title">Documents à contrôler</div>
      <div class="recap-value" id="recapDocuments">{{ recap_ns.documents }}</div>
    </div>
    <div class="recap-card recap-compte">
      <div class="recap-title">Compte à créer</div>
      <div class="recap-value" id="recapCompte">{{ recap_ns.compte }}</div>
    </div>
    <div class="recap-card recap-instruction">
      <div class="recap-title">Instruction en cours</div>
      <div class="recap-value" id="recapInstruction">{{ recap_ns.instruction }}</div>
    </div>
  </section>

  <table>
    <thead>
      <tr>
        <th>Nom</th>
        <th>Prénom</th>
        <th>Téléphone</th>
        <th>Affecter une formation</th>
        <th>Formation</th>
        <th>Dates de formation</th>
        <th>Générer attestation</th>
        <th>Gérer les documents</th>
        <th>Télécharger les documents</th>
        <th>DRACAR</th>
        <th>Espace CNAPS</th>
        <th>Statut CNAPS</th>
        <th>Commentaire / Supprimer</th>
      </tr>
    </thead>
    <tbody>
    {% for r in requests %}
      {% set all_docs_conformes = (r.total_docs > 0 and r.total_docs == r.conformes) %}
      {% set has_non_conformes = (r.non_conformes > 0) %}
      {% set has_pending_docs = (r.en_attente > 0) %}
      {% set is_new_dossier = not (r.formation and r.session_date) %}
      <tr data-pending-documents="{{ r.en_attente or 0 }}" data-is-new-dossier="{{ '1' if is_new_dossier else '0' }}">
        <td>{{ r.nom }}</td>
        <td>{{ r.prenom }}</td>
        <td>
          <input
            type="tel"
            class="telephone-input"
            data-request-id="{{ r.id }}"
            value="{{ r.telephone or '' }}"
            placeholder="Ex: 0612345678"
          >
          <div class="save-hint">Sauvegarde automatique</div>
        </td>
        <td>
          {% if r.formation and r.session_date %}
            <button class="btn grey" disabled>Affectée</button>
          {% else %}
            <button class="btn" onclick="openAssign({{ r.id }})">Affecter une formation</button>
          {% endif %}
        </td>
        <td>{{ r.formation or '-' }}</td>
        <td>{{ r.session_date or '-' }}</td>
        <td>
          {% if r.dossier_id and r.formation %}
            <a class="btn" href="/attestation/{{ r.dossier_id }}">Générer</a>
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          <a class="btn {% if has_pending_docs %}warning-pending{% elif all_docs_conformes %}success{% elif has_non_conformes %}danger{% endif %}" href="/a-traiter/{{ r.id }}/documents">{% if all_docs_conformes %}✅ {% endif %}Gérer les documents</a>
        </td>
        <td>
          {% if all_docs_conformes %}
            <a class="btn success" href="/a-traiter/{{ r.id }}/download">✅ Télécharger les documents</a>
          {% else %}
            <button class="btn grey" disabled>Télécharger les documents</button>
          {% endif %}
        </td>
        <td>
          <div style="font-size:13px;line-height:1.5;">
            <div><strong>Login :</strong> {{ r.email }}</div>
            {% set dracar_password = (r.nom[:1]|upper) ~ (r.nom[1:]|lower) ~ (r.date_naissance|replace('/','')) ~ '@' %}
            <div><strong>Mot de passe :</strong> <span data-dracar-password>{{ dracar_password }}</span></div>
            <a
              href="{{ dracar_auth_url }}"
              target="_blank"
              rel="noopener"
              class="dracar-link"
              data-login="{{ r.email }}"
              data-password="{{ dracar_password }}"
            >
              Lien Espace DRACAR
            </a>
            <div style="font-size:12px;color:#6b7280;margin-top:4px;">Le mot de passe est copié automatiquement au clic.</div>
          </div>
        </td>
        <td>
          {% set espace = (r.espace_cnaps or 'A créer')|trim %}
          <select name="espace_cnaps" data-request-id="{{ r.id }}" class="cnaps-select {% if espace == 'A créer' %}espace-a-creer{% elif espace == 'Créé' %}espace-cree{% elif espace == 'Validé' %}espace-valide{% else %}espace-a-creer{% endif %}">
            <option value="A créer" {% if espace == 'A créer' %}selected{% endif %}>A créer</option>
            <option value="Créé" {% if espace == 'Créé' %}selected{% endif %}>Créé</option>
            <option value="Validé" {% if espace == 'Validé' %}selected{% endif %}>Validé</option>
          </select>
          {% if espace == 'Créé' and (r.cnaps_is_expired or r.cnaps_expiration_label) %}
            <div data-cnaps-created-info>
              {% if r.cnaps_is_expired %}
                <div class="cnaps-expired-badge">Lien CNAPS expiré</div>
              {% elif r.cnaps_expiration_label %}
                <div class="cnaps-expiration">Lien CNAPS expire le {{ r.cnaps_expiration_label }}</div>
                <div class="cnaps-expiration">
                  Rappel 1 (4h avant) prévu le {{ r.cnaps_reminder_4h_label }}
                  <button type="button" class="cnaps-reminder-action" data-reminder-trigger data-request-id="{{ r.id }}" data-reminder-kind="4h">Envoyer maintenant</button>
                  <div class="cnaps-reminder-sent" data-reminder-sent="4h">{% if r.cnaps_reminder_4h_sent_at %}Rappel envoyé le {{ r.cnaps_reminder_4h_sent_at[:10].split('-')|reverse|join('/') }} à {{ r.cnaps_reminder_4h_sent_at[11:16].replace(':', 'h') }}{% endif %}</div>
                </div>
                <div class="cnaps-expiration">
                  Rappel 2 (2h avant) prévu le {{ r.cnaps_reminder_2h_label }}
                  <button type="button" class="cnaps-reminder-action" data-reminder-trigger data-request-id="{{ r.id }}" data-reminder-kind="2h">Envoyer maintenant</button>
                  <div class="cnaps-reminder-sent" data-reminder-sent="2h">{% if r.cnaps_reminder_2h_sent_at %}Rappel envoyé le {{ r.cnaps_reminder_2h_sent_at[:10].split('-')|reverse|join('/') }} à {{ r.cnaps_reminder_2h_sent_at[11:16].replace(':', 'h') }}{% endif %}</div>
                </div>
              {% endif %}
            </div>
          {% endif %}
          {% set cnaps = (r.statut_cnaps or '')|trim %}
          {% set cnaps_empty = (cnaps == '' or cnaps == '--') %}
          <button
            type="button"
            class="btn demande-a-faire-row {% if not (espace == 'Validé' and cnaps_empty) %}demande-hidden{% endif %}"
            data-demande-a-faire
          >
            Demande à faire
          </button>
        </td>
        <td>
          <form action="/statut_cnaps/{{ r.dossier_id }}" method="post">
            <select name="statut_cnaps" data-id="{{ r.dossier_id }}" class="cnaps-select {% if cnaps == 'TRANSMIS' %}statut-transmis{% elif cnaps == 'ENREGISTRÉ' %}statut-enregistre{% elif cnaps == 'INSTRUCTION' %}statut-instruction{% elif cnaps == 'ACCEPTÉ' %}statut-accepte{% elif cnaps == 'REFUSÉ' %}statut-refuse{% elif cnaps == 'DOCS COMPLEMENTAIRES' %}statut-docsmanquants{% else %}statut-default{% endif %}">
              <option value="">--</option>
              <option value="TRANSMIS" {% if cnaps == 'TRANSMIS' %}selected{% endif %}>TRANSMIS</option>
              <option value="ENREGISTRÉ" {% if cnaps == 'ENREGISTRÉ' %}selected{% endif %}>ENREGISTRÉ</option>
              <option value="INSTRUCTION" {% if cnaps == 'INSTRUCTION' %}selected{% endif %}>INSTRUCTION</option>
              <option value="ACCEPTÉ" {% if cnaps == 'ACCEPTÉ' %}selected{% endif %}>ACCEPTÉ</option>
              <option value="REFUSÉ" {% if cnaps == 'REFUSÉ' %}selected{% endif %}>REFUSÉ</option>
              <option value="DOCS COMPLEMENTAIRES" {% if cnaps == 'DOCS COMPLEMENTAIRES' %}selected{% endif %}>DOCS COMPLEMENTAIRES</option>
            </select>
          </form>
        </td>
        <td>
          <form>
            <textarea class="commentaire-input" data-id="{{ r.dossier_id }}" placeholder="Commentaire">{{ r.commentaire or '' }}</textarea>
            <div class="save-hint">Sauvegarde automatique</div>
          </form>
          <form action="/a-traiter/{{ r.id }}/delete" method="post" onsubmit="return confirm('Supprimer ?')">
            <button class="btn danger" type="submit">Supprimer</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<dialog id="assignDialog">
  <form id="assignForm" method="post">
    <h3>Affecter une formation</h3>
    <label>Formation</label>
    <select id="assignFormation" name="formation" required onchange="updateAssignDates()">
      <option value="">-- Type de formation --</option>
      <option value="APS">APS</option>
      <option value="A3P">A3P</option>
    </select>
    <label>Date</label>
    <select id="assignSessionDate" name="session_date" required>
      <option value="">-- Choisir une date --</option>
    </select>
    <div><button class="btn" type="submit">Valider</button> <button type="button" onclick="assignDialog.close()">Annuler</button></div>
  </form>
</dialog>

<script>
const sessionsByFormation = {{ formation_sessions | tojson }};
const assignDialog = document.getElementById('assignDialog');
const assignForm = document.getElementById('assignForm');
const assignFormation = document.getElementById('assignFormation');
const assignSessionDate = document.getElementById('assignSessionDate');

function updateAssignDates(){
  assignSessionDate.innerHTML = '<option value="">-- Choisir une date --</option>';
  const dates = sessionsByFormation[assignFormation.value] || [];
  dates.forEach(function(dateLabel){
    assignSessionDate.add(new Option(dateLabel, dateLabel));
  });
}

function openAssign(id){
  assignForm.action = `/a-traiter/${id}/assign`;
  assignFormation.value = '';
  updateAssignDates();
  assignDialog.showModal();
}

function applyCnapsClass(select){
  const value = select.value;
  const map = {
    "TRANSMIS": "statut-transmis",
    "ENREGISTRÉ": "statut-enregistre",
    "INSTRUCTION": "statut-instruction",
    "ACCEPTÉ": "statut-accepte",
    "REFUSÉ": "statut-refuse",
    "DOCS COMPLEMENTAIRES": "statut-docsmanquants"
  };
  select.classList.remove('statut-transmis','statut-enregistre','statut-instruction','statut-accepte','statut-refuse','statut-docsmanquants','statut-default');
  select.classList.add('cnaps-select');
  select.classList.add(map[value] || 'statut-default');
}

function normalizeValue(value){
  return (value || '')
    .toString()
    .trim()
    .normalize('NFD')
    .replace(/[̀-ͯ]/g, '')
    .toLowerCase();
}

function shouldShowDemande(row){
  const espaceSelect = row.querySelector("select[name='espace_cnaps']");
  const statutSelect = row.querySelector("select[name='statut_cnaps']");
  if (!espaceSelect || !statutSelect) return false;

  const espaceValue = normalizeValue(espaceSelect.value);
  const statutValue = (statutSelect.value || '').toString().trim();
  const isStatutEmpty = statutValue === '' || statutValue === '--';

  return espaceValue === 'valide' && isStatutEmpty;
}

function refreshDemandeIndicators(){
  const rows = document.querySelectorAll('tbody tr');
  let demandeCount = 0;
  let nouveauCount = 0;
  let documentsCount = 0;
  let compteCount = 0;
  let instructionCount = 0;

  rows.forEach(row => {
    const rowButton = row.querySelector('[data-demande-a-faire]');
    const espaceSelect = row.querySelector("select[name='espace_cnaps']");
    const statutSelect = row.querySelector("select[name='statut_cnaps']");

    const visible = shouldShowDemande(row);
    if (rowButton) {
      rowButton.classList.toggle('demande-hidden', !visible);
    }
    if (visible) demandeCount += 1;

    if (row.dataset.isNewDossier === '1') {
      nouveauCount += 1;
    }

    documentsCount += Number(row.dataset.pendingDocuments || 0);

    if (espaceSelect && normalizeValue(espaceSelect.value) === 'a creer') {
      compteCount += 1;
    }

    if (statutSelect && (statutSelect.value || '').toString().trim() === 'INSTRUCTION') {
      instructionCount += 1;
    }
  });

  const recapDemande = document.getElementById('recapDemande');
  const recapNouveau = document.getElementById('recapNouveau');
  const recapDocuments = document.getElementById('recapDocuments');
  const recapCompte = document.getElementById('recapCompte');
  const recapInstruction = document.getElementById('recapInstruction');

  if (recapDemande) recapDemande.textContent = demandeCount;
  if (recapNouveau) recapNouveau.textContent = nouveauCount;
  if (recapDocuments) recapDocuments.textContent = documentsCount;
  if (recapCompte) recapCompte.textContent = compteCount;
  if (recapInstruction) recapInstruction.textContent = instructionCount;
}

function refreshCnapsCreatedInfo(row){
  const espaceSelect = row.querySelector("select[name='espace_cnaps']");
  const createdInfo = row.querySelector('[data-cnaps-created-info]');
  if (!espaceSelect || !createdInfo) return;

  const isCreated = normalizeValue(espaceSelect.value) === 'cree';
  createdInfo.style.display = isCreated ? '' : 'none';
}

function applyEspaceClass(select){
  const value = select.value;
  const map = {
    "A créer": "espace-a-creer",
    "Créé": "espace-cree",
    "Validé": "espace-valide"
  };
  select.classList.remove('espace-a-creer','espace-cree','espace-valide');
  select.classList.add('cnaps-select');
  select.classList.add(map[value] || 'espace-a-creer');
}

document.querySelectorAll("select[name='statut_cnaps']").forEach(select => {
  applyCnapsClass(select);
  select.addEventListener('change', () => {
    const cid = select.dataset.id;
    if (!cid) return;

    fetch(`/statut_cnaps/${cid}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ statut_cnaps: select.value })
    }).then(() => {
      applyCnapsClass(select);
      refreshDemandeIndicators();
    });
  });
});

async function syncEspaceStatus(select){
  const rid = select.dataset.requestId;
  if (!rid) return;
  if (select.dataset.syncRunning === '1') return;

  select.dataset.syncRunning = '1';

  try {
    while (select.dataset.syncQueuedValue) {
      const queuedValue = select.dataset.syncQueuedValue;
      select.dataset.syncQueuedValue = '';

      await fetch(`/a-traiter/${rid}/espace-cnaps`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ espace_cnaps: queuedValue })
      });
    }
  } finally {
    select.dataset.syncRunning = '0';
    applyEspaceClass(select);
    refreshDemandeIndicators();
  }
}

document.querySelectorAll("select[name='espace_cnaps']").forEach(select => {
  applyEspaceClass(select);
  select.dataset.syncRunning = '0';
  select.dataset.syncQueuedValue = '';
  refreshCnapsCreatedInfo(select.closest('tr'));

  select.addEventListener('change', () => {
    select.dataset.syncQueuedValue = select.value;
    refreshCnapsCreatedInfo(select.closest('tr'));
    syncEspaceStatus(select);
  });
});

document.querySelectorAll('[data-reminder-trigger]').forEach(button => {
  button.addEventListener('click', async () => {
    const requestId = button.dataset.requestId;
    const reminderKind = button.dataset.reminderKind;
    if (!requestId || !reminderKind) return;

    button.disabled = true;
    const originalText = button.textContent;
    button.textContent = 'Envoi...';

    try {
      const response = await fetch(`/a-traiter/${requestId}/cnaps-reminder`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reminder_kind: reminderKind })
      });

      const data = await response.json().catch(() => ({}));
      if (!response.ok || !data.ok) {
        throw new Error(data.error || "Impossible d'envoyer le rappel");
      }

      const sentLabel = data.sent_label || '';
      const target = button.parentElement?.querySelector(`[data-reminder-sent="${reminderKind}"]`);
      if (target) {
        target.textContent = sentLabel ? `Rappel envoyé le ${sentLabel}` : 'Rappel envoyé';
      }
    } catch (error) {
      window.alert(error.message || "Impossible d'envoyer le rappel");
      button.disabled = false;
      button.textContent = originalText;
      return;
    }

    button.textContent = 'Envoyé';
  });
});

refreshDemandeIndicators();

document.querySelectorAll('.commentaire-input[data-id]').forEach(input => {
  let timeoutId;
  const save = () => {
    const cid = input.dataset.id;
    if (!cid) return;
    fetch(`/commentaire/${cid}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ commentaire: input.value })
    });
  };

  input.addEventListener('input', () => {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(save, 350);
  });

  input.addEventListener('blur', save);
});

document.querySelectorAll('.telephone-input[data-request-id]').forEach(input => {
  let timeoutId;
  let lastSaved = (input.value || '').trim();

  const hasEnoughDigits = (value) => {
    const digits = (value || '').replace(/\D/g, '');
    return digits.length >= 9;
  };

  const save = ({ showAlertOnError = true } = {}) => {
    const rid = input.dataset.requestId;
    if (!rid) return;

    const value = (input.value || '').trim();
    if (value === lastSaved) return;

    fetch(`/a-traiter/${rid}/telephone`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ telephone: value })
    }).then(async (response) => {
      if (!response.ok) {
        const data = await response.json().catch(() => ({}));
        throw new Error(data.error || 'Erreur de sauvegarde du téléphone');
      }

      lastSaved = value;
      input.value = value;
    }).catch((error) => {
      if (showAlertOnError) {
        window.alert(error.message || 'Impossible de sauvegarder le téléphone');
      }
      input.value = lastSaved;
    });
  };

  input.addEventListener('input', () => {
    clearTimeout(timeoutId);
    const value = (input.value || '').trim();
    if (value && !hasEnoughDigits(value)) {
      return;
    }
    timeoutId = setTimeout(() => save({ showAlertOnError: false }), 350);
  });

  input.addEventListener('blur', () => save({ showAlertOnError: true }));
});

document.querySelectorAll('.dracar-link').forEach(link => {
  link.addEventListener('click', (event) => {
    event.preventDefault();

    const login = link.dataset.login || '';
    const password = link.dataset.password || '';
    const rawUrl = link.getAttribute('href');
    if (!rawUrl) return;

    let dracarUrl;
    try {
      dracarUrl = new URL(rawUrl, window.location.origin);
      if (login) {
        dracarUrl.searchParams.set('login_hint', login);
      }
    } catch {
      window.open(rawUrl, '_blank', 'noopener');
      return;
    }

    window.open(dracarUrl.toString(), '_blank', 'noopener');

    const passwordToCopy = password;
    const canUseClipboard = navigator.clipboard && window.isSecureContext && Boolean(passwordToCopy);

    if (canUseClipboard) {
      navigator.clipboard
        .writeText(passwordToCopy)
        .then(() => {
          window.alert('Mot de passe DRACAR copié. Collez-le dans le champ avec Ctrl+V.');
        })
        .catch(() => {
          window.prompt('Copiez uniquement le mot de passe DRACAR :', passwordToCopy);
        });
      return;
    }

    window.prompt('Copiez uniquement le mot de passe DRACAR :', passwordToCopy);
  });
});
</script>
</body>
</html>
